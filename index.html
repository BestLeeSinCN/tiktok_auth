<!DOCTYPE html>
<html>
<head><meta charset="utf-8"/><title>TikTok Callback</title></head>
<body>
<script>
function initTikTokLogin(paramsJson) {
  try {
    var params = JSON.parse(paramsJson);
  } catch(e) {
    console.error('parse params error', e);
    return;
  }

  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  const returnedState = urlParams.get('state');

  if (code) {
    const payload = JSON.stringify({code: code, state: returnedState});
    // 在 WebView 中，这个 channel 名字必须和 Flutter 端一致
    if (window.TikTokLoginChannel && window.TikTokLoginChannel.postMessage) {
      window.TikTokLoginChannel.postMessage(payload);
    } else {
      // 如果是在普通浏览器打开，可以直接把结果渲染或转发回你的 server
      console.log('Auth result:', payload);
    }
    return;
  }

  // 否则去授权页
  const authUrl =
    'https://www.tiktok.com/v2/auth/authorize/?' +
    'client_key=' + encodeURIComponent(params.clientKey) +
    '&response_type=code' +
    '&scope=' + encodeURIComponent(params.scope) +
    '&redirect_uri=' + encodeURIComponent(params.redirectUri) +
    '&state=' + encodeURIComponent(params.state);

  window.location.href = authUrl;
}
</script>
<p>Redirecting to TikTok...</p>
</body>
</html>
